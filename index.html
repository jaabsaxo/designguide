<!DOCTYPE html>
<html>
<body>
  <table>
    <tr>
      <td style="width: 75%;">
        <h1>API Review</h1>
      </td>
      <td>
        <i> "We fail down here, so we don't fail up there" - Niel Armstrong &#128640 	
          &#127765 </i>
      </td>
    </tr>
  </table>
  <table style="width: 100%;">
    <tr>
      <td style="width: 50%;">
        <form>
          <input type="text" id="fname" name="fname">
        </form>
      </td>
      <td>
        <button onclick="Load()">Load</button>
        <button onclick="Save()">Save</button>
        <button onclick="Reset()">Reset</button>
      </td>
    </tr>
  </table style="width: 100%;">
  <br />
  
  <table id ="menu"></table>
  <br />
  <table id="content"></table>
  <script>
    state = {"view": "Design Basics"};
    document.getElementById("fname").style.width="99%";
    document.getElementById("fname").value = localStorage.getItem("gghfj-previous-endpoint")

    function SetToggleState() {
      let stateNumber = event.target.id.split("-")[1];
      if (stateNumber) {
        let cN = stateNumber.split(".")[0];
        let qN = stateNumber.split(".")[1];
        let currentState = state["report"][state["view"]][cN].questions[qN].s;
        if (currentState == "Not Rated") {
          state["report"][state["view"]][cN].questions[qN].s = "✅";
          state["report"][state["view"]][cN].questions[qN].c = "";
        } else if (currentState == "✅") {
          state["report"][state["view"]][cN].questions[qN].s = "❌";
          state["report"][state["view"]][cN].questions[qN].c = "Comment..";
        } else if (currentState == "❌") {
          state["report"][state["view"]][cN].questions[qN].s = "✅";
          state["report"][state["view"]][cN].questions[qN].c = "";
        }
      }
      Save();
      renderState();
    }

    function CollapseOrExpand() {
      let elementNumber = event.target.id.split("-")[1];
      if (elementNumber) {
        if (state["report"][state["view"]][elementNumber].visibility == 1) {
          state["report"][state["view"]][elementNumber].visibility = 0;
        } else {
          state["report"][state["view"]][elementNumber].visibility = 1;
        }
      }
      renderState();
    }

    function Save() {
      var endpoint = document.getElementById("fname").value;
      localStorage.setItem(endpoint, JSON.stringify(state["report"]));
      localStorage.setItem("gghfj-previous-endpoint", endpoint);
    }

    function Load() {
      var endpoint = document.getElementById("fname").value;
      if (localStorage.getItem(endpoint) === null) {
        fetch("https://jaabsaxo.github.io/designguide-config/config.json").then(r => r.json()).then( newState => {
          state["report"] = newState;
          renderState()
        })
      } else {
        state["report"]  = JSON.parse(localStorage.getItem(endpoint));
        renderState()
      }      
    }

    function Reset() {
      fetch("https://jaabsaxo.github.io/designguide-config/config.json").then(r => r.json()).then( newState => {
          state["report"] = newState;
          renderState()
        })
    }

    function getCard(i){
      let title = state["report"][state["view"]][i].title;
      let questions = state["report"][state["view"]][i].questions;
      let visible = state["report"][state["view"]][i].visibility;
      var s = "<div><h3 id=\"t-" + i + "\">" + title + "</h3>";
      s = s + "<div id=\"c-"+ i + "\">";

      if (visible == 1) {
        s = s + "<table>";

        for (let j in questions) {
            let q = questions[j].q;
            let c = questions[j].c;
            let ss = questions[j].s;

            let idx = i + "." + j; 
            s = s + "<tr>";

            s = s + "<td>";
            s = s + "<div style=\"width: 800px;\" id=\"q-" + idx + "\">" + q + "</div>"
            s = s + "</td>";

            s = s + "<td>";
            s = s + "<div id=\"s-" + idx + "\">" + ss + "</div>";
            s = s + "</td>";

            s = s + "</tr>";

            if (c != "") {
              s = s + "<tr>";
              s = s + "<td>";
              s = s + "<div id=\"e-"+ idx +"\">";
              s = s + "<input type=\"text\" placeholder=\"" + c + "\" id=\"ee-" + idx + "\"><br>"
              s = s + "</div>";
              s = s + "</td>";
              s = s + "</tr>";
            }

        }
        s = s + "</table>"
      }
      s = s + "</div>";
      return s;
    }

    function renderState(){
      var table = document.getElementById('content'); 
      table.innerHTML = "";
      for (let i in state["report"][state["view"]]) {
        let card = getCard(i);
        var row = table.insertRow(-1);
        var cell1 = row.insertCell(-1);
        cell1.innerHTML = card;
        for (let j in state["report"][state["view"]][i].questions) {
          document.getElementById("t-"+i).addEventListener("click", CollapseOrExpand);
          if ((state["report"][state["view"]][i].visibility == 1) ) {
            let idx = i + "." + j; 
            document.getElementById("s-"+idx).addEventListener("click", SetToggleState);
            document.getElementById("q-"+idx).addEventListener("click", SetToggleState);
            if (state["report"][state["view"]][i].questions[j].c != "") {
              document.getElementById("ee-"+idx).style.width = "800px";
            }
          }
        }
      }
      var table = document.getElementById('menu'); 
      table.innerHTML = "";
      var row = table.insertRow(0);
      for (let key in state["report"]) {
        var cell = row.insertCell(-1);
        let isSelected = key==state["view"];
        console.log(isSelected);
        cell.innerHTML = getMenuButton(key, isSelected);
      }
    }

    function getMenuButton(name, isSelected) {
      htmlString = "<button id=\"m-" + name;
      htmlString = htmlString + "\"onclick=\"MenuClick()\"";
      if (isSelected) {
        htmlString = htmlString + "style=\"background-color:white; border: none; border-bottom-style: solid; border-bottom-width: 1px;\"";
      } else {
        htmlString = htmlString + "style=\"background-color:white; border: none;\"";
      }
      htmlString = htmlString + ">";
      htmlString = htmlString + name;
      htmlString = htmlString + "</button>";
      return htmlString;
    }

    function MenuClick() {
      state["view"] = event.target.id.split("-")[1];
      renderState();
    }

    Load();
  </script>
</body>
</html>
