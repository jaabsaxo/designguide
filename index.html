<!DOCTYPE html>
<html>

<body>
  <h1>Design Guide</h1>
  <form>
    <label for="fname">Paste endpoint here:</label><br>
    <input type="text" id="fname" name="fname"><br>
  </form>
  <br />
  <p id="scoreId">Review Score: 0 %</p>
  <br />
  <button onclick="checkScore()">Calculate score</button>
  <button onclick="Load()">Load</button>
  <button onclick="Save()">Save</button>
  <br />
  <br />
  <hr>
  <table id="content"></table>
  <hr>
  <script>

    state = {};
    document.getElementById("fname").style.width="800px";


    function SetToggleState() {
      console.log(event.target.id);
      let stateNumber = event.target.id.split("-")[1];
      if (stateNumber) {
        let cN = stateNumber.split(".")[0];
        let qN = stateNumber.split(".")[1];
        let currentState = state[cN].questions[qN].s;
        if (currentState == "Not Rated") {
          state[cN].questions[qN].s = "✅";
          state[cN].questions[qN].c = "";
        } else if (currentState == "✅") {
          state[cN].questions[qN].s = "❌";
          state[cN].questions[qN].c = "Comment..";
        } else if (currentState == "❌") {
          state[cN].questions[qN].s = "✅";
          state[cN].questions[qN].c = "";
        }
      }
      renderState(state);
    }


    function CollapseOrExpand() {
      let elementNumber = event.target.id.split("-")[1];
      console.log(elementNumber)
      if (elementNumber) {
        let elementId = "c-" + elementNumber;
        console.log(document.getElementById(elementId).innerHTML)
        if (document.getElementById(elementId).innerHTML == "") {
          document.getElementById(elementId).innerHTML = "<table><tr><td><div id=\"q-1\">Does this work?</div></td><td><div id=\"s-1\">Not Rated</div></td></tr></table><div id=\"e-1\"></div>"
        } else {
          console.log("Should go here")
          document.getElementById(elementId).innerHTML = "";
        }
      }
    }

    document.getElementById("fname").value = localStorage.getItem("gghfj-previous-endpoint")

    function checkScore() {
      var score = 0;
      var number_of_checks = 0;
      var all = document.getElementsByTagName("input");
      for (let item of all) {
        if (item.type == "checkbox") {
          if (document.getElementById(item.id).checked) {
            score += 1;
          }
          number_of_checks += 1;
        }
      }
      var score = Math.round((score / number_of_checks) * 1000) / 10;
      document.getElementById("scoreId").innerHTML = "Review Score: " + score + "%"
    }


    function Save() {
      var endpoint = document.getElementById("fname").value
      console.log(state);
      localStorage.setItem(endpoint, JSON.stringify(state));
      localStorage.setItem("gghfj-previous-endpoint", endpoint);
    }

    function Load() {
      var endpoint = document.getElementById("fname").value
      let newState = JSON.parse(localStorage.getItem(endpoint));
      state = newState;
      renderState(state);
    }

    function getElementFromState(i) {
      for (let k in state) {
        if (i == state[k].i) {
          return 
        }
      }
    }

    function getCard(state, i){

      let title = state[i].title;
      let questions = state[i].questions;
      var s = "<div><h3 id=\"t-" + i + "\">" + title + "</h3>";
      s = s + "<div id=\"c-"+ i + "\">";
      s = s + "<table>";

      for (let j in questions) {
          let q = questions[j].q;
          let c = questions[j].c;
          let ss = questions[j].s;

          let idx = i + "." + j; 
          s = s + "<tr>";

          s = s + "<td>";
          s = s + "<div id=\"q-" + idx + "\">" + q + "</div>"
          s = s + "</td>";

          s = s + "<td>";
          s = s + "<div id=\"s-" + idx + "\">" + ss + "</div>";
          s = s + "</td>";

          s = s + "</tr>";

          if (c != "") {
            s = s + "<tr>";
            s = s + "<td>";
            s = s + "<div id=\"e-"+ idx +"\">";
            s = s + "<input type=\"text\" value=\"" + c + "\" id=\"ee-" + idx + "\"><br>"
            s = s + "</div>";
            s = s + "</td>";
            s = s + "</tr>";
          }

        }
      s = s + "</table></div>"
      return s;
    }

    function renderState(state){
      var table = document.getElementById('content'); 
      for (let i in state) {
        let card = getCard(state, i);
        var row = table.insertRow(0);
        var cell1 = row.insertCell(0);
        cell1.innerHTML = card;
        document.getElementById("t-"+i).addEventListener("click", SetToggleState);
        for (let j in state[i].questions) {
          let idx = i + "." + j; 
          document.getElementById("s-"+idx).addEventListener("click", SetToggleState);
          document.getElementById("q-"+idx).addEventListener("click", SetToggleState);
          document.getElementById("t-"+i).addEventListener("click", CollapseOrExpand);
          if (state[i].questions[j].c != "") {
            document.getElementById("ee-"+idx).style.width = "800px";
          }
        }
      }
    }

    function onLoad() {
      fetch("https://jaabsaxo.github.io/designguide-config/config.json").then(r => r.json()).then( newState => {
        console.log(newState);
        state = newState
        renderState(state)
      })
    }
    onLoad()
  </script>
</body>
</html>