<!DOCTYPE html>
<html>
<body>
  <table>
    <tr>
      <td style="width: 75%;">
        <h1>API Review</h1>
      </td>
      <td>
        <i> "We fail down here, so we don't fail up there" - Niel Armstrong &#128640 	
          &#127765 </i>
      </td>
    </tr>
  </table>
  <form>
    <label for="fname">Paste endpoint here:</label><br>
    <input type="text" id="fname" name="fname"><br>
  </form>
  
  <br />
  <p id="scoreId">Review Score: 0 %</p>
  <br />
  <button onclick="checkScore()">Calculate score</button>
  <button onclick="Load()">Load</button>
  <button onclick="Save()">Save</button>
  <button onclick="Reset()">Reset</button>
  <br />
  <br />
  <hr>
  <table id="content"></table>
  <script>
    state = {};
    document.getElementById("fname").style.width="800px";
    document.getElementById("fname").value = localStorage.getItem("gghfj-previous-endpoint")

    function SetToggleState() {
      let stateNumber = event.target.id.split("-")[1];
      if (stateNumber) {
        let cN = stateNumber.split(".")[0];
        let qN = stateNumber.split(".")[1];
        let currentState = state[cN].questions[qN].s;
        if (currentState == "Not Rated") {
          state[cN].questions[qN].s = "✅";
          state[cN].questions[qN].c = "";
        } else if (currentState == "✅") {
          state[cN].questions[qN].s = "❌";
          state[cN].questions[qN].c = "Comment..";
        } else if (currentState == "❌") {
          state[cN].questions[qN].s = "✅";
          state[cN].questions[qN].c = "";
        }
      }
      Save();
      checkScore();
      renderState();
    }

    function CollapseOrExpand() {
      let elementNumber = event.target.id.split("-")[1];
      if (elementNumber) {
        let elementId = "c-" + elementNumber;
        if (document.getElementById(elementId).innerHTML == "") {
          renderState();
        } else {
          document.getElementById(elementId).innerHTML = "";
        }
      }
    }

    function checkScore() {
      var score = 0;
      var number_of_checks = 0;
      for (let i in state) {
        for (let j in state[i].questions) {
          let status = state[i].questions[j].s;
          if ( status == "✅") {
            score += 1;
          } else if ( status == "Not Rated") {
            continue
          }
          number_of_checks += 1;
        }
      }
      var score = Math.round((score / number_of_checks) * 1000) / 10;
      document.getElementById("scoreId").innerHTML = "Review Score: " + score + " %"
    }

    function Save() {
      var endpoint = document.getElementById("fname").value;
      localStorage.setItem(endpoint, JSON.stringify(state));
      localStorage.setItem("gghfj-previous-endpoint", endpoint);
    }

    function Load() {
      var endpoint = document.getElementById("fname").value;
      if (localStorage.getItem(endpoint) === null) {
        fetch("https://jaabsaxo.github.io/designguide-config/config.json").then(r => r.json()).then( newState => {
          state = newState;
          renderState()
        })
      } else {
        state = JSON.parse(localStorage.getItem(endpoint));
        renderState()
      }      
    }

    function Reset() {
      fetch("https://jaabsaxo.github.io/designguide-config/config.json").then(r => r.json()).then( newState => {
          state = newState;
          checkScore();
          renderState()
        })
    }

    function getCard(state, i){
      let title = state[i].title;
      let questions = state[i].questions;
      var s = "<div><h3 id=\"t-" + i + "\">" + title + "</h3>";
      s = s + "<div id=\"c-"+ i + "\">";
      s = s + "<table>";

      for (let j in questions) {
          let q = questions[j].q;
          let c = questions[j].c;
          let ss = questions[j].s;

          let idx = i + "." + j; 
          s = s + "<tr>";

          s = s + "<td>";
          s = s + "<div style=\"width: 800px;\" id=\"q-" + idx + "\">" + q + "</div>"
          s = s + "</td>";

          s = s + "<td>";
          s = s + "<div id=\"s-" + idx + "\">" + ss + "</div>";
          s = s + "</td>";

          s = s + "</tr>";

          if (c != "") {
            s = s + "<tr>";
            s = s + "<td>";
            s = s + "<div id=\"e-"+ idx +"\">";
            s = s + "<input type=\"text\" placeholder=\"" + c + "\" id=\"ee-" + idx + "\"><br>"
            s = s + "</div>";
            s = s + "</td>";
            s = s + "</tr>";
          }

        }
      s = s + "</table></div>"
      return s;
    }

    function renderState(){
      var table = document.getElementById('content'); 
      table.innerHTML = "";
      for (let i in state) {
        let card = getCard(state, i);
        var row = table.insertRow(-1);
        var cell1 = row.insertCell(-1);
        cell1.innerHTML = card;
        document.getElementById("t-"+i).addEventListener("click", SetToggleState);
        for (let j in state[i].questions) {
          let idx = i + "." + j; 
          document.getElementById("s-"+idx).addEventListener("click", SetToggleState);
          document.getElementById("q-"+idx).addEventListener("click", SetToggleState);
          document.getElementById("t-"+i).addEventListener("click", CollapseOrExpand);
          if (state[i].questions[j].c != "") {
            document.getElementById("ee-"+idx).style.width = "800px";
          }
        }
      }
    }

    Load();
  </script>
</body>
</html>
